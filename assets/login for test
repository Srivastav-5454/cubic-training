import React, { Component } from "react";
import { Link } from "react-router-dom";
import "../styles/Login.css";

export default class Login extends Component {
    constructor(props) {
        super(props);
        this.state = {
            mobileNumber: "",
            password: "",
            err: "",
        };
    }

    handleChange = (e) => {
        this.setState({ [e.target.name]: e.target.value });
    };

    onSubmit = async (e) => {
        e.preventDefault();

        const { mobileNumber, password } = this.state;
        this.setState({ err: "" });

        if (!/^\d{10}$/.test(mobileNumber)) {
            this.setState({ err: "Please enter a valid mobile number (10 digits)." });
            return;
        }

        if (!password.trim()) {
            this.setState({ err: "Please enter password." });
            return;
        }

        try {
            const response = await fetch("http://localhost:8080/auth/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({

                    "password": password,
                    "phoneNumber": mobileNumber,
                }),
            });

            const result = await response.json();

            if (response.ok) {

                localStorage.setItem("jwtToken", result.token);
                localStorage.setItem("mobileNumber", mobileNumber);

                window.location.href = "/TapGate";
            } else {
                this.setState({ err: result.message || "Invalid credentials" });
            }
        } catch (ex) {
            this.setState({ err: ex.message || "Login failed" });
        }
    };

    render() {
        const { mobileNumber, password, err } = this.state;

        return (
            <div className="auth-page">
                <div className="brand">
                    <div className="brand-title">Metro Transit</div>
                    <div className="brand-subtitle">Your digital fare collection system</div>
                </div>

                <div className="auth-card">
                    <div className="auth-header">
                        <h2>Welcome back</h2>
                        <p>Sign in to access your transit cards</p>
                    </div>

                    {err && <div className="auth-error">{err}</div>}

                    <form onSubmit={this.onSubmit}>
                        <label className="auth-label">Mobile Number</label>
                        <input
                            className="auth-input"
                            type="tel"
                            name="mobileNumber"
                            value={mobileNumber}
                            onChange={this.handleChange}
                        />

                        <label className="auth-label">Password</label>
                        <input
                            className="auth-input"
                            type="password"
                            name="password"
                            value={password}
                            onChange={this.handleChange}
                        />

                        <button className="auth-btn" type="submit">
                            Sign in
                        </button>
                    </form>

                    <div className="auth-footer">
                        Don&apos;t have an account? <Link to="/register">Sign up</Link>
                    </div>
                </div>
            </div>
        );
    }
}
